
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>How can I more efficiently use finite-differenced components in the ODE? &#8212; Dymos</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How can I debug models when things go wrong?" href="debugging.html" />
    <link rel="prev" title="How do I run two phases parallel-in-time?" href="tandem_phases.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/dymos_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Dymos</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Multidisciplinary Optimal Control Library
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Installation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../installation.html">
   Installing Dymos
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/collocation.html">
   What is collocation?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/defining_odes.html">
   Defining ODEs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/optimal_control.html">
   Optimal Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/intro_to_dymos/intro_ivp.html">
   Modeling Dynamic Systems with Dymos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/intro_to_dymos/intro_segments.html">
   Segments of Phases
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Examples and Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../examples/examples.html">
   Dymos by Example
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/brachistochrone/brachistochrone.html">
     The Brachistochrone
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/balanced_field/balanced_field.html">
     Aircraft Balanced Field Length Calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/vanderpol/vanderpol.html">
     The Van der Pol Oscillator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/commercial_aircraft/commercial_aircraft.html">
     Commercial Aircraft Range Maximization by Differential Inclusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/double_integrator/double_integrator.html">
     Double Integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/hypersensitive/hypersensitive.html">
     Hyper-Sensitive Problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/finite_burn_orbit_raise/finite_burn_orbit_raise.html">
     Two-Burn Orbit Raise
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/length_constrained_brachistochrone/length_constrained_brachistochrone.html">
     The Length-Constrained Brachistochrone
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/min_time_climb/min_time_climb.html">
     Supersonic Interceptor Minimum Time Climb
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/multi_phase_cannonball/multi_phase_cannonball.html">
     Multi-Phase Cannonball
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/multibranch_trajectory/multibranch_trajectory.html">
     Multibranch Trajectory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/racecar/racecar.html">
     Race car Lap Simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/reentry/reentry.html">
     Single-Phase Space Shuttle Reentry
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/ssto_earth/ssto_earth.html">
     SSTO Earth Launch
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Feature Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../features/phases/phases_list.html">
   Phases
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/phases.html">
     Phases of a Trajectory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/segments.html">
     Segments
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/variables.html">
     Variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/constraints.html">
     Constraints
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/objective.html">
     Objective
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../features/phases/timeseries.html">
     Timeseries Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../features/trajectories/trajectories.html">
   Organizing Phases into Trajectories
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../features/exploiting_sparsity.html">
   Exploiting Sparsity for Faster Derivative Calculation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../features/plotting.html">
   Plotting Timeseries
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Frequentsly Asked Questions
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="faq.html">
   Frequently Asked Questions
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="add_ode_output_to_timeseries.html">
     How do I add an ODE output to the timeseries outputs?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="connect_scalar_parameters_to_ode.html">
     How do I connect a scalar input to the ODE?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="upstream_analysis.html">
     How do connect the outputs of an upstream analysis as inputs to Dymos?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="downstream_analysis.html">
     How do connect the outputs of Dymos to a downstream analysis?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tandem_phases.html">
     How do I run two phases parallel-in-time?
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     How can I more efficiently use finite-differenced components in the ODE?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="debugging.html">
     How can I debug models when things go wrong?
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dymos API Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../api/api.html">
   Dymos Reference API
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/run_problem.html">
     The Dymos run_problem function
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/phase_api.html">
     The Phase API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/trajectory_api.html">
     The Trajectory API
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Whats New
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../release_notes/whats_new.html">
   What’s New
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../release_notes/version_0.16.0.html">
     dymos 0.16.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release_notes/version_0.17.0.html">
     dymos 0.17.0
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Contributing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributing/contributing.html">
   Contributing to Dymos
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/faq/use_partial_coloring.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/OpenMDAO/dymos"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/OpenMDAO/dymos/issues/new?title=Issue%20on%20page%20%2Ffaq/use_partial_coloring.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-comparison">
   Performance comparison
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="how-can-i-more-efficiently-use-finite-differenced-components-in-the-ode">
<h1>How can I more efficiently use finite-differenced components in the ODE?<a class="headerlink" href="#how-can-i-more-efficiently-use-finite-differenced-components-in-the-ode" title="Permalink to this headline">¶</a></h1>
<p>Sometimes it’s overly burdensome to get the analytic partials for a component.
In this case, OpenMDAO can use finite-differencing to approximate the partials of that component and then use those approximated partials when assembling the total derivatives.
However, if a dense sub-jacobian pattern is prescribed somewhere within the ODE, it will effect all dependent calculations and cause related total jacobians to have dense patterns.
In effect, a dense partial-derivative jacobian destroys the sparsity pattern of the problem.
To alleviate this, OpenMDAO provides a mechanism to <a class="reference external" href="http://openmdao.org/twodocs/versions/latest/features/experimental/simul_coloring_fd_cs.html">color the partials of a single component</a>.</p>
<p>As an example, consider the minimum time-to-climb problem.
The ODE of this problem consists of several components.
In this case, we’re going to switch one of these components from using analytic derivatives to a finite-difference approximation.
Here he use an option on the component so that we can toggle the use of partial coloring on and off for testing, but that’s not generally necessary.</p>
<p>=== “class DynamicPressureCompFD”
</p>
<p>!!! note
When using finite-differenced partials, they should not be specified in the <code class="docutils literal notranslate"><span class="pre">compute_partials</span></code> method.
In fact, if all partials in the component are being approximated, <code class="docutils literal notranslate"><span class="pre">compute_partials</span></code> should just be omitted.</p>
<p>In this usage of <code class="docutils literal notranslate"><span class="pre">declare_coloring</span></code>, we use the following arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wrt=['*']</span></code>
This is used to specify that we wish to find sparse partials <strong>w</strong>ith <strong>r</strong>espect <strong>t</strong>o all inputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method=['fd']</span></code>
We’re using finite differencing to approximate the partials for coloring.
This is separate from the method used to actually compute the units.
Using <code class="docutils literal notranslate"><span class="pre">'cs'</span></code> here (complex-step) will result in more accurate derivatives if model supports the use of complex inputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tol=1.0E-6</span></code>
Any value in the Jacobian with a value greater than this will be considered a non-zero.
Since finite differencing is used and it generally encounters noise on the order of 1.0E-8, this tolerance should be larger than that.
If using complex-step for the approximation method this tolerance can be smaller - as small as about 1.0E-15.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_full_jacs</span></code>
Compute the full jacobian twice before determining the partial sparsity pattern.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_improve_pct</span></code>
If the number of solves required to compute the derivatives isn’t reduced by at least this amount, then coloring is ignored and the dense jacobian is used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">show_summary</span> <span class="pre">=</span> <span class="pre">True</span></code>
Print the sparsity of the partial derivative jacobian.  This will display something like:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jacobian</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>  <span class="p">(</span> <span class="mf">1.67</span><span class="o">%</span> <span class="n">nonzero</span><span class="p">)</span>
<span class="n">FWD</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">2</span>   <span class="n">REV</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Total</span> <span class="n">colors</span> <span class="n">vs</span><span class="o">.</span> <span class="n">total</span> <span class="n">size</span><span class="p">:</span> <span class="mi">2</span> <span class="n">vs</span> <span class="mi">120</span>  <span class="p">(</span><span class="mf">98.3</span><span class="o">%</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Sparsity</span> <span class="n">computed</span> <span class="n">using</span> <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1e-06</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">sparsity</span><span class="p">:</span> <span class="mf">0.011868</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">coloring</span><span class="p">:</span> <span class="mf">0.001385</span> <span class="n">sec</span><span class="o">.</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">show_sparsity=True</span></code>
Display the sparsity pattern in standard output to provide a visual indication whether or not it is working.
Here, this outputs the jacobian of <code class="docutils literal notranslate"><span class="pre">rho</span></code> with two diagonal bands - one for each of the two inputs.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Approx</span> <span class="n">coloring</span> <span class="k">for</span> <span class="s1">&#39;traj.phases.phase0.rhs_col.aero.q_comp&#39;</span> <span class="p">(</span><span class="k">class</span> <span class="nc">DynamicPressureCompFD</span><span class="p">)</span>
<span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.............................</span> <span class="mi">0</span>  <span class="n">q</span>
<span class="o">.</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">............................</span> <span class="mi">1</span>  <span class="n">q</span>
<span class="o">..</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">...........................</span> <span class="mi">2</span>  <span class="n">q</span>
<span class="o">...</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">..........................</span> <span class="mi">3</span>  <span class="n">q</span>
<span class="o">....</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.........................</span> <span class="mi">4</span>  <span class="n">q</span>
<span class="o">.....</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">........................</span> <span class="mi">5</span>  <span class="n">q</span>
<span class="o">......</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.......................</span> <span class="mi">6</span>  <span class="n">q</span>
<span class="o">.......</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">......................</span> <span class="mi">7</span>  <span class="n">q</span>
<span class="o">........</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.....................</span> <span class="mi">8</span>  <span class="n">q</span>
<span class="o">.........</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">....................</span> <span class="mi">9</span>  <span class="n">q</span>
<span class="o">..........</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">...................</span> <span class="mi">10</span>  <span class="n">q</span>
<span class="o">...........</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">..................</span> <span class="mi">11</span>  <span class="n">q</span>
<span class="o">............</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.................</span> <span class="mi">12</span>  <span class="n">q</span>
<span class="o">.............</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">................</span> <span class="mi">13</span>  <span class="n">q</span>
<span class="o">..............</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">...............</span> <span class="mi">14</span>  <span class="n">q</span>
<span class="o">...............</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">..............</span> <span class="mi">15</span>  <span class="n">q</span>
<span class="o">................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.............</span> <span class="mi">16</span>  <span class="n">q</span>
<span class="o">.................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">............</span> <span class="mi">17</span>  <span class="n">q</span>
<span class="o">..................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">...........</span> <span class="mi">18</span>  <span class="n">q</span>
<span class="o">...................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">..........</span> <span class="mi">19</span>  <span class="n">q</span>
<span class="o">....................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.........</span> <span class="mi">20</span>  <span class="n">q</span>
<span class="o">.....................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">........</span> <span class="mi">21</span>  <span class="n">q</span>
<span class="o">......................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.......</span> <span class="mi">22</span>  <span class="n">q</span>
<span class="o">.......................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">......</span> <span class="mi">23</span>  <span class="n">q</span>
<span class="o">........................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.....</span> <span class="mi">24</span>  <span class="n">q</span>
<span class="o">.........................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">....</span> <span class="mi">25</span>  <span class="n">q</span>
<span class="o">..........................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">...</span> <span class="mi">26</span>  <span class="n">q</span>
<span class="o">...........................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">..</span> <span class="mi">27</span>  <span class="n">q</span>
<span class="o">............................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span><span class="o">.</span> <span class="mi">28</span>  <span class="n">q</span>
<span class="o">.............................</span><span class="n">f</span><span class="o">.............................</span><span class="n">f</span> <span class="mi">29</span>  <span class="n">q</span>
<span class="o">|</span><span class="n">rho</span>
                              <span class="o">|</span><span class="n">v</span>
</pre></div>
</div>
<p>The sparsity patterns of the resulting total-derivative jacobian matrices are shown below.
Finite differencing without partial derivative coloring causes the sparsity pattern to be dense for a large portion of the matrix.
Since the dynamic pressure affects all of the defect constraints, the algorithm treats each defect constraint as if it is <em>potentially</em> dependent upon all altitude and velocity values throughout the phase.
However, if partial derivative coloring is used, OpenMDAO recovers the same sparsity pattern as the analytic derivative case.</p>
<p></p>
<div class="section" id="performance-comparison">
<h2>Performance comparison<a class="headerlink" href="#performance-comparison" title="Permalink to this headline">¶</a></h2>
<p>In this instance, the following performance was noted for the minimum time-to-climb case with 30 Gauss-Lobatto segments.
Using OpenMDAO’s partial derivative coloring buys back a signficant amount of performance lost to finite differencing.
It should be noted that the IPOPT option <code class="docutils literal notranslate"><span class="pre">alpha_for_y</span></code> can have a signficant impact on performance here.
The default ‘primal’ step results in faster convergence for the sparse analytic case, but results in problematic convergence for the finite-differenced versions.
Switching the option using <code class="docutils literal notranslate"><span class="pre">p.driver.opt_settings['alpha_for_y']</span> <span class="pre">=</span> <span class="pre">'safer-min-dual-infeas'</span></code> results in a ‘safer’ step size and faster convergence of the finite-differenced versions, at the expense of some time in the analytic case.
Using that setting, the analytic optimization time was roughly 8.7 seconds compared to 7.5 seconds for the finite difference case with coloring.
Dense finite differencing in that case, was roughly twice as fast, at 15.5 seconds.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Derivative Type</p></th>
<th class="head"><p>Optimization Time (s)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Sparse Analytic</p></td>
<td><p>6.3</p></td>
</tr>
<tr class="row-odd"><td><p>Finite Difference (Dense)</p></td>
<td><p>29.9</p></td>
</tr>
<tr class="row-even"><td><p>Finite Difference (with Coloring)</p></td>
<td><p>10.5</p></td>
</tr>
</tbody>
</table>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./faq"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="tandem_phases.html" title="previous page">How do I run two phases parallel-in-time?</a>
    <a class='right-next' id="next-link" href="debugging.html" title="next page">How can I debug models when things go wrong?</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Dymos Development Team<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>
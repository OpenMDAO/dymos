
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exploiting Sparsity for Faster Derivative Calculation &#8212; Dymos</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting Timeseries" href="plotting.html" />
    <link rel="prev" title="Organizing Phases into Trajectories" href="trajectories/trajectories.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/dymos_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Dymos</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Multidisciplinary Optimal Control Library
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Installation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../installation.html">
   Installing Dymos
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/collocation.html">
   What is collocation?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/defining_odes.html">
   Defining ODEs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/optimal_control.html">
   Optimal Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/intro_to_dymos/intro_ivp.html">
   Modeling Dynamic Systems with Dymos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started/intro_to_dymos/intro_segments.html">
   Segments of Phases
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Examples and Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../examples/examples.html">
   Dymos by Example
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/brachistochrone/brachistochrone.html">
     The Brachistochrone
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/balanced_field/balanced_field.html">
     Aircraft Balanced Field Length Calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/vanderpol/vanderpol.html">
     The Van der Pol Oscillator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/commercial_aircraft/commercial_aircraft.html">
     Commercial Aircraft Range Maximization by Differential Inclusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/double_integrator/double_integrator.html">
     Double Integrator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/hypersensitive/hypersensitive.html">
     Hyper-Sensitive Problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/finite_burn_orbit_raise/finite_burn_orbit_raise.html">
     Two-Burn Orbit Raise
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/length_constrained_brachistochrone/length_constrained_brachistochrone.html">
     The Length-Constrained Brachistochrone
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/min_time_climb/min_time_climb.html">
     Supersonic Interceptor Minimum Time Climb
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/multi_phase_cannonball/multi_phase_cannonball.html">
     Multi-Phase Cannonball
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/multibranch_trajectory/multibranch_trajectory.html">
     Multibranch Trajectory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/racecar/racecar.html">
     Race car Lap Simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/reentry/reentry.html">
     Single-Phase Space Shuttle Reentry
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/ssto_earth/ssto_earth.html">
     SSTO Earth Launch
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Feature Reference
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="phases/phases_list.html">
   Phases
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/phases.html">
     Phases of a Trajectory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/segments.html">
     Segments
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/variables.html">
     Variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/constraints.html">
     Constraints
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/objective.html">
     Objective
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="phases/timeseries.html">
     Timeseries Outputs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="trajectories/trajectories.html">
   Organizing Phases into Trajectories
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Exploiting Sparsity for Faster Derivative Calculation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plotting.html">
   Plotting Timeseries
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Frequentsly Asked Questions
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../faq/faq.html">
   Frequently Asked Questions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/add_ode_output_to_timeseries.html">
     How do I add an ODE output to the timeseries outputs?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/connect_scalar_parameters_to_ode.html">
     How do I connect a scalar input to the ODE?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/upstream_analysis.html">
     How do connect the outputs of an upstream analysis as inputs to Dymos?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/downstream_analysis.html">
     How do connect the outputs of Dymos to a downstream analysis?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/tandem_phases.html">
     How do I run two phases parallel-in-time?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/use_partial_coloring.html">
     How can I more efficiently use finite-differenced components in the ODE?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../faq/debugging.html">
     How can I debug models when things go wrong?
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/features/exploiting_sparsity.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/OpenMDAO/OpenMDAO_Book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/OpenMDAO/OpenMDAO_Book/issues/new?title=Issue%20on%20page%20%2Ffeatures/exploiting_sparsity.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-using-openmdao-s-coloring-capability">
   Step 1: Using OpenMDAO’s Coloring Capability
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-the-coloring-algorithm-separately">
   Running the coloring algorithm separately
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#viewing-the-sparsity">
   Viewing the sparsity
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reverse-mode-coloring">
   Reverse-mode coloring
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance-comparison-with-and-without-simultaneous-derivatives">
   Performance comparison with and without simultaneous derivatives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-of-components-with-finite-differencing-in-the-ode">
   Use of Components with Finite-Differencing in the ODE
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="exploiting-sparsity-for-faster-derivative-calculation">
<h1>Exploiting Sparsity for Faster Derivative Calculation<a class="headerlink" href="#exploiting-sparsity-for-faster-derivative-calculation" title="Permalink to this headline">¶</a></h1>
<p>A key feature of collocation algorithms such as high-order Gauss-Lobatto collocation or the Radau pseudospectral method is that they exhibit a large degree of <em>sparsity</em> in the total Jacobian.
By modeling the state-time histories as a series of polynomial segments, the collocation defect constraints within each segment are largely dependent only on the state and control values within the same segment.
Pseudospectral optimization tools such as SOCS, OTIS, and GPOPS-II have long used the notion of <em>sparse finite differences</em> to perturb multiple independent variables simultaneously when approximating the constraint Jacobian.
This can significantly reduce the computational effort required to approximate the entire Jacobian via finite difference.</p>
<p>The unique way in which OpenMDAO assembles analytic derivatives across the problem allows us to use a similar approach to provide the analytic constraint Jacobian.
This approach can reduce the time required to solve moderately-sized optimal control problems by orders of magnitude and make the convergence more robust.</p>
<p>OpenMDAO uses a <a class="reference external" href="http://openmdao.org/twodocs/versions/latest/features/core_features/working_with_derivatives/simul_derivs.html">“coloring” algorithm</a> to determine which variables can be perturbed simultaneously to determine the total constraint Jacobian.
Variables in the same “color” each impact a unique constraint, such that when all the variables are perturbed we can be assured that any change in the constraint vector is due to at most one scalar variable.
Since OpenMDAO uses a linear solver to assemble to total derivative Jacobian, coloring reduces the number of linear solves from one per variable (or constraint in adjoint mode) to one per <em>color</em>.
In the brachistochrone example below this reduces the number of linear solves from 1001 to 9.
This capability makes problems of moderate size run orders of magnitude faster, and can make intractably large problems tractable.</p>
<p>!!! note
While some optimizers (SNOPT and IPOPT) are particularly adept at dealing with large, sparse nonlinear programming problems, coloring can still benefit drivers which do not account for sparsity (such as SLSQP) since it significantly reduces the cost of computing the Jacobian.</p>
<div class="section" id="step-1-using-openmdao-s-coloring-capability">
<h2>Step 1: Using OpenMDAO’s Coloring Capability<a class="headerlink" href="#step-1-using-openmdao-s-coloring-capability" title="Permalink to this headline">¶</a></h2>
<p>OpenMDAO supports dynamic coloring, meaning it can automatically run the Jacobian coloring algorithm before handing the problem to the optimizer.
To enable this capability, simply add the following line to the driver.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">()</span>
</pre></div>
</div>
<p>By default the coloring algorithm will attempt to determine the sparsity pattern of the total jacobian by filling the partial jacobian matrices with random noise and searching for nonzeros in the resulting total jacobian.
At times this might report that it failed to converge on a number of nonzero entries.
This is due to the introduction of noise during the matrix inversion by the system’s linear solver.
This can be remedied by using a different linear solver, such as PETScKrylov, or by telling the coloring algorithm to accept a given tolerance on the nonzero elements rather than trying to determine it automatically.
This can be accomplished with the following options to declare coloring:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.0E-12</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Setting <code class="docutils literal notranslate"><span class="pre">orders</span></code> to None prevents the automatic tolerance detection.
The value of <code class="docutils literal notranslate"><span class="pre">tol</span></code> is up to the user.
If it is too large, then some nonzero values will erroneously be determined to be zeros and the total derivative will be incorrect.
If <code class="docutils literal notranslate"><span class="pre">tol</span></code> is too small then the sparsity pattern may be overly conservative and degrade performance somewhat.
We recommend letting the coloring algorithm detect the sparsity automatically and only resorting to a fixed tolerance if necessary.</p>
</div>
<div class="section" id="running-the-coloring-algorithm-separately">
<h2>Running the coloring algorithm separately<a class="headerlink" href="#running-the-coloring-algorithm-separately" title="Permalink to this headline">¶</a></h2>
<p>OpenMDAO supports the ability to run the coloring algorithm “offline” and then provide the data to the driver via a saved file.
This is potentially useful to users whose model is particularly expensive to color, and whom aren’t changing the problem structure between runs.</p>
<p>!!! note</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Adding or removing constraints, controls, states, or parameters, as well as changing the objective variable or changing the grid will all affect the fundamental size of the optimization problem and therefore will require a new coloring.
Simply changing constraint bounds or scaling on variables and constraints will not fundamentally change the size of the problem and will therefore not require a recoloring.
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">use_static_coloring</span></code> Driver method in OpenMDAO is documented <a class="reference external" href="http://openmdao.org/twodocs/versions/latest/features/core_features/working_with_derivatives/simul_derivs.html#static-coloring">here</a>.</p>
</div>
<div class="section" id="viewing-the-sparsity">
<h2>Viewing the sparsity<a class="headerlink" href="#viewing-the-sparsity" title="Permalink to this headline">¶</a></h2>
<p>The summary of the sparsity pattern can be obtained following a run with the <a class="reference external" href="http://openmdao.org/twodocs/versions/latest/other/om_command.html">OpenMDAO command line view_coloring utility</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openmdao view_coloring coloring_files/total_coloring.pkl 
</pre></div>
</div>
<p>where the <code class="docutils literal notranslate"><span class="pre">coloring_files/total_coloring.pkl</span></code> file is automatically generated in the run directory by OpenMDAO when coloring is used.
For this example, the <a class="reference internal" href="../examples/brachistochrone/brachistochrone.html"><span class="doc std std-doc">Brachistochrone example</span></a> is used with 100 3rd-order segments in the Radau transcription.
The output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jacobian</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">1099</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>  <span class="p">(</span> <span class="mf">0.54</span><span class="o">%</span> <span class="n">nonzero</span><span class="p">)</span>
<span class="n">FWD</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">11</span>   <span class="n">REV</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Total</span> <span class="n">colors</span> <span class="n">vs</span><span class="o">.</span> <span class="n">total</span> <span class="n">size</span><span class="p">:</span> <span class="mi">11</span> <span class="n">vs</span> <span class="mi">1200</span>  <span class="p">(</span><span class="mf">99.1</span><span class="o">%</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Sparsity</span> <span class="n">computed</span> <span class="n">using</span> <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1e-08</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">sparsity</span><span class="p">:</span> <span class="mf">1.706023</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">coloring</span><span class="p">:</span> <span class="mf">0.038774</span> <span class="n">sec</span><span class="o">.</span>
</pre></div>
</div>
<p>In addition, adding the <code class="docutils literal notranslate"><span class="pre">--view</span></code> flag to the command will generate a visualization of the sparsity using matplotlib.</p>
<p>The gray checkerboard represents the vectorized variables (columns) and constraints (rows).
In this case, the column groupings correspond <code class="docutils literal notranslate"><span class="pre">t_duration</span></code>, followed by the states <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">v</span></code>, and finally the control <code class="docutils literal notranslate"><span class="pre">theta</span></code>.
The rows groupings correspond to the state defects on <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">v</span></code>, followed by the <code class="docutils literal notranslate"><span class="pre">theta</span></code> control value continuity constraints and the <code class="docutils literal notranslate"><span class="pre">theta</span></code> control rate continuity constraints.
The ordering of these variables and constraints is the same as output by the pyOptSparseDriver.</p>
<p>In this case we can see that there is a single dense column on the left.
This is the phase duration, which impacts all of the defect constraints in the problem.</p>
<p><img alt="Sparsity plot for the 100-segment brachistochrone problem" src="../_images/sparsity_plot.png" /></p>
</div>
<div class="section" id="reverse-mode-coloring">
<h2>Reverse-mode coloring<a class="headerlink" href="#reverse-mode-coloring" title="Permalink to this headline">¶</a></h2>
<p>Pseudospectral optimal control problems often have roughly equal numbers of constraints and design variables.
As a result, there’s doesn’t tend to be a significant increase in performance by using adjoint (reverse) differentiation.</p>
<p>In Dymos, when the <code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> flag on a state or transcription is used, an underlying nonlinear solver is used to satisfy the constraint defects.
The optimizer only controls the initial or final state values in a phase as the design variables, and the solver is responsible for satisfying the corresponding state collocation defects.
As a result, the problem is effectively transformed into a shooting problem (single shooting when compressed transcription is used, or multiple shooting when it is not).
These problems tend to exhibit many more design variables than constraints, and thus adjoint differentiation can be advantageous.
Fortunately, the coloring algorithm used in OpenMDAO automatically detects this and colors the problem in reverse mode.</p>
<p>If we run the 100-segment Radau brachistochrone problem with <code class="docutils literal notranslate"><span class="pre">solve_segments=forward</span></code> (taking care to replace the terminal state bounds with nonlinear boundary constraints), the following coloring is obtained:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jacobian</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>  <span class="p">(</span> <span class="mf">2.79</span><span class="o">%</span> <span class="n">nonzero</span><span class="p">)</span>
<span class="n">FWD</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">0</span>   <span class="n">REV</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">102</span>
<span class="n">Total</span> <span class="n">colors</span> <span class="n">vs</span><span class="o">.</span> <span class="n">total</span> <span class="n">size</span><span class="p">:</span> <span class="mi">102</span> <span class="n">vs</span> <span class="mi">201</span>  <span class="p">(</span><span class="mf">49.3</span><span class="o">%</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Sparsity</span> <span class="n">computed</span> <span class="n">using</span> <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1e-25</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">sparsity</span><span class="p">:</span> <span class="mf">0.414226</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">coloring</span><span class="p">:</span> <span class="mf">0.017739</span> <span class="n">sec</span><span class="o">.</span>
</pre></div>
</div>
<p><img alt="Sparsity plot for the 100-segment brachistochrone problem with solve_segments enabled." src="../_images/sparsity_plot_solve_segments.png" /></p>
<p>In this case, the majority of the constraints pertain to the control value and rate continuity.
The majority of the design variables are the control values at the control input nodes.
There are two dense rows at bottom are the nonlinear boundary constraints on <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>.
The entirety of the control history impacts these values in a shooting formulation.</p>
</div>
<div class="section" id="performance-comparison-with-and-without-simultaneous-derivatives">
<h2>Performance comparison with and without simultaneous derivatives<a class="headerlink" href="#performance-comparison-with-and-without-simultaneous-derivatives" title="Permalink to this headline">¶</a></h2>
<p>In comparison, the 100-segment, Radau-based brachistochrone problem <em>without</em> coloring solves in roughly two minutes with a 2.4 GHz Intel Core i9 processor using the IPOPT optimizer.
While computing the sensitivity itself takes only 16 seconds, the large amount of data being used to store knowably-zero quantities is quite large, which results in a lot of time spent in the optimizer dealing with that data.</p>
<p>For the  <code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> case, we see that it significantly reduces the size of the problem from the optimizer’s perspective, driving the optimization time down significantly.
The additional cost of solving the collocation problem with a Newton solver is reflected in the somewhat greater objective and sensitivity time compared to the nominal case.</p>
<p>The key takeaways from the following table are:</p>
<ul class="simple">
<li><p>Optimizer-driven pseudospectral approaches rely on the exploitation of sparsity to be efficient</p></li>
<li><p>Shooting approaches, when numerically appropriate, can be reasonably competitive with pseudospectral approaches under adjoint differentiation.</p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>With Dynamic Coloring</p></th>
<th class="head"><p>Without Coloring</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> With Coloring</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> Without Coloring</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Total Time</p></td>
<td><p>1.5692</p></td>
<td><p>127.9437</p></td>
<td><p>2.2911</p></td>
<td><p>4.6551</p></td>
</tr>
<tr class="row-odd"><td><p>User Objective Time</p></td>
<td><p>0.0510</p></td>
<td><p>0.0957</p></td>
<td><p>0.4937</p></td>
<td><p>0.6104</p></td>
</tr>
<tr class="row-even"><td><p>User Sensitivity Time</p></td>
<td><p>0.6618</p></td>
<td><p>16.5347</p></td>
<td><p>1.6315</p></td>
<td><p>2.9759</p></td>
</tr>
<tr class="row-odd"><td><p>Interface Time</p></td>
<td><p>0.5668</p></td>
<td><p>2.1390</p></td>
<td><p>0.1016</p></td>
<td><p>0.1558</p></td>
</tr>
<tr class="row-even"><td><p>Opt Solver Time</p></td>
<td><p>0.2896</p></td>
<td><p>109.1743</p></td>
<td><p>0.0643</p></td>
<td><p>0.9129</p></td>
</tr>
<tr class="row-odd"><td><p>Calls to Objective Function</p></td>
<td><p>24</p></td>
<td><p>28</p></td>
<td><p>23</p></td>
<td><p>23</p></td>
</tr>
<tr class="row-even"><td><p>Calls to Sens Function</p></td>
<td><p>24</p></td>
<td><p>28</p></td>
<td><p>23</p></td>
<td><p>23</p></td>
</tr>
</tbody>
</table>
<p>Performance aside, there are other factors to consider when choosing between shooting methods or optimizer-driven pseudospectral approaches.
Primarily, the shooting methods propagate the entirety of the trajectory at each iteration.
If there are singularities in the equations of motion, and a given control profile causes the propagation to encounter a singularity, the solver will fail to converge and it can stall the entire solution process.
Optimizer-driven approaches can better avoid these issues because the trajectory is not required to be physically realizable at each iteration.</p>
</div>
<div class="section" id="use-of-components-with-finite-differencing-in-the-ode">
<h2>Use of Components with Finite-Differencing in the ODE<a class="headerlink" href="#use-of-components-with-finite-differencing-in-the-ode" title="Permalink to this headline">¶</a></h2>
<p>Check out <a class="reference internal" href="../faq/use_partial_coloring.html"><span class="doc std std-doc">this page</span></a> to learn more about how to more efficiently use finite-differencing in ODE components.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="trajectories/trajectories.html" title="previous page">Organizing Phases into Trajectories</a>
    <a class='right-next' id="next-link" href="plotting.html" title="next page">Plotting Timeseries</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Dymos Development Team<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>

<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Exploiting Sparsity for Faster Derivative Calculation &#8212; Dymos</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css?v=9678755d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'features/exploiting_sparsity';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting Timeseries" href="plotting.html" />
    <link rel="prev" title="Organizing Phases into Trajectories" href="trajectories/trajectories.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/dymos_logo.png" class="logo__image only-light" alt="Dymos - Home"/>
    <script>document.write(`<img src="../_static/dymos_logo.png" class="logo__image only-dark" alt="Dymos - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Multidisciplinary Optimal Control Library
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing Dymos</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../getting_started/optimal_control.html">Optimal Control</a></li>




<li class="toctree-l1"><a class="reference internal" href="../getting_started/transcriptions.html">Optimal Control Transcriptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/defining_odes.html">Defining ODEs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/collocation.html">What is collocation?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro_to_dymos/intro_ivp.html">Modeling Dynamic Systems with Dymos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro_to_dymos/intro_segments.html">Segments of Phases</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples and Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../examples/examples.html">Dymos by Example</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/brachistochrone/brachistochrone.html">The Brachistochrone</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/brachistochrone/brachistochrone_upstream_init_duration_states.html">The Brachistochrone with externally-sourced initial state values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/vanderpol/vanderpol.html">The Van der Pol Oscillator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/balanced_field/balanced_field.html">Aircraft Balanced Field Length Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/balanced_field/balanced_field_funccomp.html">Balanced Field Length using OpenMDAO’s Function Wrapping Components.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/bryson_denham/bryson_denham.html">The Bryson-Denham Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/commercial_aircraft/commercial_aircraft.html">Commercial Aircraft Range Maximization by Differential Inclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/double_integrator/double_integrator.html">Double Integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/hull/hull_problem.html">The Hull Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/hypersensitive/hypersensitive.html">Hyper-Sensitive Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/finite_burn_orbit_raise/finite_burn_orbit_raise.html">Two-Burn Orbit Raise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/length_constrained_brachistochrone/length_constrained_brachistochrone.html">The Length-Constrained Brachistochrone</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/min_time_climb/min_time_climb.html">Supersonic Interceptor Minimum Time Climb</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/mountain_car/mountain_car.html">The Mountain Car Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/moon_landing/moon_landing.html">Moon Landing Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/multi_phase_cannonball/multi_phase_cannonball.html">Multi-Phase Cannonball</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/multibranch_trajectory/multibranch_trajectory.html">Multibranch Trajectory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/racecar/racecar.html">Race car Lap Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/reentry/reentry.html">Single-Phase Space Shuttle Reentry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/ssto_earth/ssto_earth.html">SSTO Earth Launch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/ssto_moon_linear_tangent/ssto_moon_linear_tangent.html">SSTO Lunar Ascent with Linear Tangent Guidance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/ssto_moon_polynomial_controls/ssto_moon_polynomial_controls.html">SSTO Lunar Ascent with Polynomial Controls</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/robertson_problem/robertson_problem.html">The Robertson Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/water_rocket/water_rocket.html">Water Rocket</a></li>

<li class="toctree-l2"><a class="reference internal" href="../examples/cart_pole/cart_pole.html">Cart-Pole Optimal Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/brachistochrone/brachistochrone_tandem_phases.html">Brachistochrone with tandem phases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/implicit_duration/brachistochrone_implicit_duration.html">Boundary Balance</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Feature Reference</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="phases/phases_list.html">Phases</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="phases/phases.html">Phases of a Trajectory</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/analytic_phases.html">Analytic Phases in Dymos</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/segments.html">Segments</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/constraints.html">Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/objective.html">Objective</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases/timeseries.html">Timeseries Outputs</a></li>

<li class="toctree-l2"><a class="reference internal" href="phases/calc_expressions.html">Calculation Expressions</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="trajectories/trajectories.html">Organizing Phases into Trajectories</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Exploiting Sparsity for Faster Derivative Calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting.html">Plotting Timeseries</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/add_ode_output_to_timeseries.html">How do I add an ODE output to the timeseries outputs?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/connect_scalar_parameters_to_ode.html">How do I connect a scalar input to the ODE?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/upstream_analysis.html">How do I connect the outputs of an upstream analysis as inputs to Dymos?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/downstream_analysis.html">How do I connect the outputs of Dymos to a downstream analysis?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/tandem_phases.html">How do I run two phases parallel-in-time?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/use_partial_coloring.html">How can I more efficiently use finite-differenced components in the ODE?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/debugging.html">How can I debug models when things go wrong?</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dymos API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/api.html">Dymos Reference API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/run_problem_function.html">The run_problem function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/phase_api.html">Phase Options</a></li>

<li class="toctree-l2"><a class="reference internal" href="../api/transcriptions_api.html">The Transcriptions API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/trajectory_api.html">The Trajectory API</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contributing/contributing.html">Contributing to Dymos</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/OpenMDAO/dymos/blob/master/docs/dymos_book/features/exploiting_sparsity.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/OpenMDAO/dymos" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/OpenMDAO/dymos/issues/new?title=Issue%20on%20page%20%2Ffeatures/exploiting_sparsity.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/features/exploiting_sparsity.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Exploiting Sparsity for Faster Derivative Calculation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-using-openmdao-s-coloring-capability">Step 1: Using OpenMDAO’s Coloring Capability</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-coloring-algorithm-separately">Running the coloring algorithm separately</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-the-sparsity">Viewing the sparsity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-mode-coloring">Reverse-mode coloring</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-comparison-with-and-without-simultaneous-derivatives">Performance comparison with and without simultaneous derivatives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-of-components-with-finite-differencing-in-the-ode">Use of Components with Finite-Differencing in the ODE</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="exploiting-sparsity-for-faster-derivative-calculation">
<h1>Exploiting Sparsity for Faster Derivative Calculation<a class="headerlink" href="#exploiting-sparsity-for-faster-derivative-calculation" title="Link to this heading">#</a></h1>
<p>A key feature of collocation algorithms such as high-order Gauss-Lobatto collocation or the Radau pseudospectral method is that they exhibit a large degree of <em>sparsity</em> in the total Jacobian.
By modeling the state-time histories as a series of polynomial segments, the collocation defect constraints within each segment are largely dependent only on the state and control values within the same segment.
Pseudospectral optimization tools such as SOCS, OTIS, and GPOPS-II have long used the notion of <em>sparse finite differences</em> to perturb multiple independent variables simultaneously when approximating the constraint Jacobian.
This can significantly reduce the computational effort required to approximate the entire Jacobian via finite difference.</p>
<p>The unique way in which OpenMDAO assembles analytic derivatives across the problem allows us to use a similar approach to provide the analytic constraint Jacobian.
This approach can reduce the time required to solve moderately-sized optimal control problems by orders of magnitude and make the convergence more robust.</p>
<p>OpenMDAO uses a <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/features/core_features/working_with_derivatives/simul_derivs.html">“coloring” algorithm</a> to determine which variables can be perturbed simultaneously to determine the total constraint Jacobian.
Variables in the same “color” each impact a unique constraint, such that when all the variables are perturbed we can be assured that any change in the constraint vector is due to at most one scalar variable.
Since OpenMDAO uses a linear solver to assemble to total derivative Jacobian, coloring reduces the number of linear solves from one per variable (or constraint in adjoint mode) to one per <em>color</em>.
In the brachistochrone example below this reduces the number of linear solves from 1001 to 9.
This capability makes problems of moderate size run orders of magnitude faster, and can make intractably large problems tractable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While some optimizers (SNOPT and IPOPT) are particularly adept at dealing with large, sparse nonlinear programming problems, coloring can still benefit drivers which do not account for sparsity (such as SLSQP) since it significantly reduces the cost of computing the Jacobian.</p>
</div>
<section id="step-1-using-openmdao-s-coloring-capability">
<h2>Step 1: Using OpenMDAO’s Coloring Capability<a class="headerlink" href="#step-1-using-openmdao-s-coloring-capability" title="Link to this heading">#</a></h2>
<p>OpenMDAO supports dynamic coloring, meaning it can automatically run the Jacobian coloring algorithm before handing the problem to the optimizer.
To enable this capability, simply add the following line to the driver.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">()</span>
</pre></div>
</div>
<p>By default the coloring algorithm will attempt to determine the sparsity pattern of the total jacobian by filling the partial jacobian matrices with random noise and searching for nonzeros in the resulting total jacobian.
At times this might report that it failed to converge on a number of nonzero entries.
This is due to the introduction of noise during the matrix inversion by the system’s linear solver.
This can be remedied by using a different linear solver, such as PETScKrylov, or by telling the coloring algorithm to accept a given tolerance on the nonzero elements rather than trying to determine it automatically.
This can be accomplished with the following options to declare coloring:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.0E-12</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Setting <code class="docutils literal notranslate"><span class="pre">orders</span></code> to None prevents the automatic tolerance detection.
The value of <code class="docutils literal notranslate"><span class="pre">tol</span></code> is up to the user.
If it is too large, then some nonzero values will erroneously be determined to be zeros and the total derivative will be incorrect.
If <code class="docutils literal notranslate"><span class="pre">tol</span></code> is too small then the sparsity pattern may be overly conservative and degrade performance somewhat.
We recommend letting the coloring algorithm detect the sparsity automatically and only resorting to a fixed tolerance if necessary.</p>
</section>
<section id="running-the-coloring-algorithm-separately">
<h2>Running the coloring algorithm separately<a class="headerlink" href="#running-the-coloring-algorithm-separately" title="Link to this heading">#</a></h2>
<p>OpenMDAO supports the ability to run the coloring algorithm “offline” and then provide the data to the driver via a saved file.
This is potentially useful to users whose model is particularly expensive to color, and whom aren’t changing the problem structure between runs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Adding or removing constraints, controls, states, or parameters, as well as changing the objective variable or changing the grid will all affect the fundamental size of the optimization problem and therefore will require a new coloring.
Simply changing constraint bounds or scaling on variables and constraints will not fundamentally change the size of the problem and will therefore not require a recoloring.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">use_static_coloring</span></code> Driver method in OpenMDAO is documented <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/features/core_features/working_with_derivatives/simul_derivs.html#static-coloring">here</a>.</p>
</section>
<section id="viewing-the-sparsity">
<h2>Viewing the sparsity<a class="headerlink" href="#viewing-the-sparsity" title="Link to this heading">#</a></h2>
<p>The summary of the sparsity pattern can be obtained following a run with the <a class="reference external" href="https://openmdao.org/newdocs/versions/latest/other_useful_docs/om_command.html">OpenMDAO command line view_coloring utility</a>.</p>
<p>where the <code class="docutils literal notranslate"><span class="pre">coloring_files/total_coloring.pkl</span></code> file is automatically generated in the run directory by OpenMDAO when coloring is used.
For this example, the <a class="reference internal" href="../examples/brachistochrone/brachistochrone.html"><span class="std std-doc">Brachistochrone example</span></a> is used with 100 3rd-order segments in the Radau transcription.
The output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jacobian</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">1099</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>  <span class="p">(</span> <span class="mf">0.54</span><span class="o">%</span> <span class="n">nonzero</span><span class="p">)</span>
<span class="n">FWD</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">11</span>   <span class="n">REV</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Total</span> <span class="n">colors</span> <span class="n">vs</span><span class="o">.</span> <span class="n">total</span> <span class="n">size</span><span class="p">:</span> <span class="mi">11</span> <span class="n">vs</span> <span class="mi">1200</span>  <span class="p">(</span><span class="mf">99.1</span><span class="o">%</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Sparsity</span> <span class="n">computed</span> <span class="n">using</span> <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1e-08</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">sparsity</span><span class="p">:</span> <span class="mf">1.706023</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">coloring</span><span class="p">:</span> <span class="mf">0.038774</span> <span class="n">sec</span><span class="o">.</span>
</pre></div>
</div>
<p>In addition, adding the <code class="docutils literal notranslate"><span class="pre">--view</span></code> flag to the command will generate a visualization of the sparsity using matplotlib.</p>
<p>The gray checkerboard represents the vectorized variables (columns) and constraints (rows).
In this case, the column groupings correspond to <code class="docutils literal notranslate"><span class="pre">t_duration</span></code>, followed by the states <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">v</span></code>, and finally the control <code class="docutils literal notranslate"><span class="pre">theta</span></code>.
The row groupings correspond to the state defects on <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">v</span></code>, followed by the <code class="docutils literal notranslate"><span class="pre">theta</span></code> control value continuity constraints and the <code class="docutils literal notranslate"><span class="pre">theta</span></code> control rate continuity constraints.
The ordering of these variables and constraints is the same as output by the pyOptSparseDriver.</p>
<p>In this case we can see that there is a single dense column on the left.
This is the phase duration, which impacts all of the defect constraints in the problem.</p>
<p><img alt="Sparsity plot for the 100-segment brachistochrone problem" src="../_images/sparsity_plot.png" /></p>
</section>
<section id="reverse-mode-coloring">
<h2>Reverse-mode coloring<a class="headerlink" href="#reverse-mode-coloring" title="Link to this heading">#</a></h2>
<p>Pseudospectral optimal control problems often have roughly equal numbers of constraints and design variables.
As a result, there doesn’t tend to be a significant increase in performance by using adjoint (reverse) differentiation.</p>
<p>In Dymos, when the <code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> flag on a state or transcription is used, an underlying nonlinear solver is used to satisfy the constraint defects.
The optimizer only controls the initial or final state values in a phase as the design variables, and the solver is responsible for satisfying the corresponding state collocation defects.
As a result, the problem is effectively transformed into a shooting problem (single shooting when compressed transcription is used, or multiple shooting when it is not).
These problems tend to exhibit many more design variables than constraints, and thus adjoint differentiation can be advantageous.
Fortunately, the coloring algorithm used in OpenMDAO automatically detects this and colors the problem in reverse mode.</p>
<p>If we run the 100-segment Radau brachistochrone problem with <code class="docutils literal notranslate"><span class="pre">solve_segments=forward</span></code> (taking care to replace the terminal state bounds with nonlinear boundary constraints), the following coloring is obtained:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jacobian</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>  <span class="p">(</span> <span class="mf">2.79</span><span class="o">%</span> <span class="n">nonzero</span><span class="p">)</span>
<span class="n">FWD</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">0</span>   <span class="n">REV</span> <span class="n">solves</span><span class="p">:</span> <span class="mi">102</span>
<span class="n">Total</span> <span class="n">colors</span> <span class="n">vs</span><span class="o">.</span> <span class="n">total</span> <span class="n">size</span><span class="p">:</span> <span class="mi">102</span> <span class="n">vs</span> <span class="mi">201</span>  <span class="p">(</span><span class="mf">49.3</span><span class="o">%</span> <span class="n">improvement</span><span class="p">)</span>

<span class="n">Sparsity</span> <span class="n">computed</span> <span class="n">using</span> <span class="n">tolerance</span><span class="p">:</span> <span class="mf">1e-25</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">sparsity</span><span class="p">:</span> <span class="mf">0.414226</span> <span class="n">sec</span><span class="o">.</span>
<span class="n">Time</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">coloring</span><span class="p">:</span> <span class="mf">0.017739</span> <span class="n">sec</span><span class="o">.</span>
</pre></div>
</div>
<p><img alt="Sparsity plot for the 100-segment brachistochrone problem with solve_segments enabled." src="../_images/sparsity_plot_solve_segments.png" /></p>
<p>In this case, the majority of the constraints pertain to the control value and rate continuity.
The majority of the design variables are the control values at the control input nodes.
The two dense rows at the bottom are the nonlinear boundary constraints on <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>.
The entirety of the control history impacts these values in a shooting formulation.</p>
</section>
<section id="performance-comparison-with-and-without-simultaneous-derivatives">
<h2>Performance comparison with and without simultaneous derivatives<a class="headerlink" href="#performance-comparison-with-and-without-simultaneous-derivatives" title="Link to this heading">#</a></h2>
<p>In comparison, the 100-segment, Radau-based brachistochrone problem <em>without</em> coloring solves in roughly two minutes with a 2.4 GHz Intel Core i9 processor using the IPOPT optimizer.
While computing the sensitivity itself takes only 16 seconds, the large amount of data being used to store knowably-zero quantities is quite large, which results in a lot of time spent in the optimizer dealing with that data.</p>
<p>For the  <code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> case, we see that it significantly reduces the size of the problem from the optimizer’s perspective, driving the optimization time down significantly.
The additional cost of solving the collocation problem with a Newton solver is reflected in the somewhat greater objective and sensitivity time compared to the nominal case.</p>
<p>The key takeaways from the following table are:</p>
<ul class="simple">
<li><p>Optimizer-driven pseudospectral approaches rely on the exploitation of sparsity to be efficient</p></li>
<li><p>Shooting approaches, when numerically appropriate, can be reasonably competitive with pseudospectral approaches under adjoint differentiation.</p></li>
</ul>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>With Dynamic Coloring</p></th>
<th class="head"><p>Without Coloring</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> With Coloring</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">solve_segments</span></code> Without Coloring</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Total Time</p></td>
<td><p>1.5692</p></td>
<td><p>127.9437</p></td>
<td><p>2.2911</p></td>
<td><p>4.6551</p></td>
</tr>
<tr class="row-odd"><td><p>User Objective Time</p></td>
<td><p>0.0510</p></td>
<td><p>0.0957</p></td>
<td><p>0.4937</p></td>
<td><p>0.6104</p></td>
</tr>
<tr class="row-even"><td><p>User Sensitivity Time</p></td>
<td><p>0.6618</p></td>
<td><p>16.5347</p></td>
<td><p>1.6315</p></td>
<td><p>2.9759</p></td>
</tr>
<tr class="row-odd"><td><p>Interface Time</p></td>
<td><p>0.5668</p></td>
<td><p>2.1390</p></td>
<td><p>0.1016</p></td>
<td><p>0.1558</p></td>
</tr>
<tr class="row-even"><td><p>Opt Solver Time</p></td>
<td><p>0.2896</p></td>
<td><p>109.1743</p></td>
<td><p>0.0643</p></td>
<td><p>0.9129</p></td>
</tr>
<tr class="row-odd"><td><p>Calls to Objective Function</p></td>
<td><p>24</p></td>
<td><p>28</p></td>
<td><p>23</p></td>
<td><p>23</p></td>
</tr>
<tr class="row-even"><td><p>Calls to Sens Function</p></td>
<td><p>24</p></td>
<td><p>28</p></td>
<td><p>23</p></td>
<td><p>23</p></td>
</tr>
</tbody>
</table>
</div>
<p>Performance aside, there are other factors to consider when choosing between shooting methods or optimizer-driven pseudospectral approaches.
Primarily, the shooting methods propagate the entirety of the trajectory at each iteration.
If there are singularities in the equations of motion, and a given control profile causes the propagation to encounter a singularity, the solver will fail to converge and it can stall the entire solution process.
Optimizer-driven approaches can better avoid these issues because the trajectory is not required to be physically realizable at each iteration.</p>
</section>
<section id="use-of-components-with-finite-differencing-in-the-ode">
<h2>Use of Components with Finite-Differencing in the ODE<a class="headerlink" href="#use-of-components-with-finite-differencing-in-the-ode" title="Link to this heading">#</a></h2>
<p>Check out <a class="reference internal" href="../faq/use_partial_coloring.html"><span class="std std-doc">this page</span></a> to learn more about how to more efficiently use finite-differencing in ODE components.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="trajectories/trajectories.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Organizing Phases into Trajectories</p>
      </div>
    </a>
    <a class="right-next"
       href="plotting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Plotting Timeseries</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-using-openmdao-s-coloring-capability">Step 1: Using OpenMDAO’s Coloring Capability</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-coloring-algorithm-separately">Running the coloring algorithm separately</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-the-sparsity">Viewing the sparsity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-mode-coloring">Reverse-mode coloring</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-comparison-with-and-without-simultaneous-derivatives">Performance comparison with and without simultaneous derivatives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-of-components-with-finite-differencing-in-the-ode">Use of Components with Finite-Differencing in the ODE</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Dymos Development Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>